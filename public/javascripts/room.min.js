function UUID(){this.id=this.createUUID()}var room={filePath:"",apiUrl:"",nwIsMinimize:!1,desktopNotice:null,nwWin:null,roomName:"",nwTray:null,msgType:{text:"text",img:"img",file:"file"},socket:null,socketUrl:"",userInfo:null,rmWin:null,whTipIntervalId:null,tipSoundObj:{key:"tip_sound",storageObj:{turn:"on"}},whHistoryUserObj:{key:"whUsers",whUserList:[]},init:function(){this.setSocket(),this.setVideo(),this.setEvent()},setVideo:function(){try{$.getJSON("/admin/getSyllabus?t="+(new Date).getTime(),{groupType:room.userInfo.groupType,groupId:room.userInfo.groupId},function(t){var e=t.data;if(e&&common.isValid(e.studioLink)){var o=JSON.parse(e.studioLink),i="";for(var s in o)if(1==o[s].code){i=o[s].url;break}if(common.isValid(i)&&0==$("#yyVideoDiv embed").length)if(i.indexOf("rtmp:")!=-1){var r='<div style="position: relative; width: 100%; height: 100%; left: 0px; top: 0px;"><object type="application/x-shockwave-flash" id="sewise_player" name="sewise_player" data="/base/lib/flash/SewisePlayer.swf" width="100%" height="100%"><param name="allowfullscreen" value="true"><param name="wmode" value="transparent"><param name="allowscriptaccess" value="always"><param name="flashvars" value="autoStart=true&amp;programId=&amp;shiftTime=&amp;lang=zh_CN&amp;type=rtmp&amp;serverApi=ServerApi.execute&amp;skin=/base/lib/flash/skins/liveOrange.swf&amp;title=&amp;draggable=true&amp;published=0&amp;streamUrl='+i+'&amp;duration=3600&amp;poster=&amp;flagDatas=&amp;videosJsonUrl=&amp;adsJsonData=&amp;statistics=&amp;customDatas=&amp;playerName=Sewise Player&amp;clarityButton=enable&amp;timeDisplay=disable&amp;controlBarDisplay=enable&amp;topBarDisplay=disable&amp;customStrings=&amp;volume=0.6&amp;key=&amp;trackCallback="></object></div>';$("#yyVideoDiv").html(r)}else $("#yyVideoDiv").html('<embed src="'+i+'" quality="high" width="100%" height="100%" align="middle" allowScriptAccess="never" allowFullScreen="true" mode="transparent" type="application/x-shockwave-flash"></embed>')}})}catch(t){console.error("setVideo has error:"+t)}},setTalkTop:function(t,e){if(t){var o=$("#groupInfoId"),i="true"==o.attr("aw")&&common.containSplitStr(o.attr("awr"),room.userInfo.userType),s=e.fromUser;$(".mymsg").show(),$(".mymsg em").hide(),$(".replybtn").attr("tm",s.publishTime).attr("uid",s.userId).attr("ts",s.talkStyle).attr("utype",s.userType),$(".sender").html(s.nickname);var r=e.content.value;e.content.msgType==room.msgType.img&&(r='<img src="'+e.content.value+'" />'),$(".xcont").html(r),$("#talk_top_id").prepend('<section class="ss-tk-info clearfix" tm="'+s.publishTime+'"><label><strong>'+s.nickname+'</strong>：</label><span style="margin-left:5px;text-align:justify;">'+r+'</span><button type="button">关闭</button><button type="button" uid="'+s.userId+'" utype="'+s.userType+'" '+(i?"":'style="display:none;"')+'" cg="'+s.clientGroup+'" nk="'+s.nickname+'" iswh="true">私聊</button><button type="button" uid="'+s.userId+'" utype="'+s.userType+'">回复</button></section>');var a=$("#talk_top_id .ss-tk-info[tm="+s.publishTime+"]");a.find("button").click(function(){var t=$(this).parents(".ss-tk-info"),e=$(this).attr("uid"),o=$(this).attr("iswh"),i=t.attr("tm");if(common.isValid(e)&&common.isBlank(o)){var s=$(this);room.setDialog(null,e,t.find("strong").addClass("reply-st").html(),s.attr("ts"),s.attr("utype"),i,s.siblings("span").html())}else common.isValid(o)&&o?room.setDialog($(this).attr("cg"),e,$(this).attr("nk"),"1",$(this).attr("utype"),i,""):(t.remove(),$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】"),$(".mymsg .replybtn[tm="+i+"]").parent().hide(),$("#contentText .txt_dia[tm="+i+"]").length>0&&$("#contentText").html(""))})}else e.publishTime&&($("#talk_top_id .ss-tk-info[tm="+e.publishTime+"]").remove(),$(".mymsg .replybtn[tm="+e.publishTime+"]").parent().hide());$("#show_top_btn strong,#top_num").text("【"+$("#talk_top_id .ss-tk-info").length+"】")},getUiId:function(){var t=new Date;return t.getTime()+"_ms"},getVisitorList:function(t){if(!common.isBlank(t))try{$(".searchResult").hide(),$(".searchResult ul").html(""),$.getJSON("/admin/getVistiorByName",{groupType:room.userInfo.groupType,groupId:room.userInfo.groupId,nickname:t},function(t){if(t){$(".searchResult").show();var e=0,o="";for(var i in t)o=t[i].userId||t[i].visitorId,$(".searchResult ul li[uid="+o+"]").length>0||(e=t[i].onlineStatus,$(".searchResult ul").append('<li uid="'+o+'" cg="'+t[i].clientGroup+'"  '+(1==e?"":'class="off"')+"><label>"+t[i].nickname+"</label></li>"));$(".searchResult ul li").click(function(){$(".searchResult").hide();var t=$(this).attr("uid");room.setWhVisitors(t.indexOf("visitor_")!=-1?-1:0,$(this).attr("cg"),t,$(this).find("label").text(),!$(this).hasClass("off")),$(".visitorDiv .wh_tab_ul li[uid="+$(this).attr("uid")+"]").click()})}})}catch(t){alert("查询异常,请联系管理员！"),console.error("getVistiorByName->"+t)}},getWhToUser:function(){var t=$(".visitorDiv .wh_tab_ul li[class~=on]");return{userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:1,userType:t.attr("utype")}},sendWhMsg:function(t){var e=room.getWhToUser(),o={uiId:room.getUiId(),fromUser:room.userInfo,content:{}};o.fromUser.toUser=e;var i=t.find(".text-min-img img");if(i.size()>0){var s=i.attr("src");s.length>1048576?alert("发送的图片大小不要超过1MB."):(room.setUploadImg(s,e),i.remove())}var r=room.getSendMsg(t);if(r===!1)return o.content={msgType:room.msgType.msg,value:""},room.setWhHistory(o),t.html(""),!1;o.content={msgType:room.msgType.text,value:r},room.socket.emit("sendMsg",o),room.setWhHistory(o),room.setWhContent(o,!0,!1),t.html("");var a={groupId:room.userInfo.groupId,mobile:room.userInfo.mobilePhone,clientGroup:"",userName:room.userInfo.nickname,roomName:decodeURI(common.getUrlParam("roomName",!0)),userSource:"web",useEquipment:"",tradingAccount:"",tradingPlatform:"",platformType:0,groupType:room.userInfo.groupType,operateEntrance:"",operationType:8,visitorId:"",sid:room.userInfo.sid,nickname:room.userInfo.nickname,email:"",videoId:"",videoName:"",courseId:"",courseName:"",teacherId:"",teacherName:""};1==room.userInfo.userType?a.clientGroup="admin":2==room.userInfo.userType?a.clientGroup="analyst":3==room.userInfo.userType&&(a.clientGroup="cs"),chatAnalyze.setUTM(!1,a)},setWhOnlineTip:function(t,e,o){if(e){if(o){var i="";"-1"==o.userType&&common.isValid(o.loginId)?(i=$(".visitorDiv ul li[uid="+o.loginId+"]"),i.length>0&&(i.attr("uid",o.userId),i.find(".wrtip").text(""),$("#wh_msg_"+o.loginId).attr("id","wh_msg_"+o.userId))):"0"==o.userType&&common.isValid(o.visitorId)&&(i=$(".visitorDiv ul li[uid="+o.visitorId+"]"),i.find(".wrtip").text(room.getWhUserCGTip(o.userType,o.clientGroup)),i.length>0&&(i.attr("uid",o.userId),$("#wh_msg_"+o.visitorId).attr("id","wh_msg_"+o.userId)));var s=$("#wh_msg_"+t+" .wh-title label").text(),r=$("#wh_msg_"+t+" .wh-title .title-tip");common.isValid(s)&&s!=o.nickname?r.text("账号转变:"+s+" --> "+o.nickname).show():r.text("").hide(),$(".visitorDiv ul li[uid="+t+"] label,#wh_msg_"+t+" .wh-title label").text(o.nickname)}$(".visitorDiv ul li[uid="+t+"]").removeClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("在线")}else $(".visitorDiv ul li[uid="+t+"]").addClass("off"),$("#wh_msg_"+t+" .wh-title strong").text("离线")},getWhUserCGTip:function(t,e){return 0==t?"active"==e?"真实A":"notActive"==e?"真实N":"simulate"==e?"模拟":"register"==e?"注册":"":1==t?"管理员":2==t?"分析师":3==t?"客服":""},setWhVisitors:function(t,e,o,i,s,r){if(0==$(".visitorDiv .wh_tab_ul li[uid="+o+"]").length){var a=$("#userListId li[id='"+o+"']").attr("ismb");$(".visitorDiv .wh_tab_ul").append('<li uid="'+o+'"  '+(s?"":'class="off"')+' utype="'+t+'"><span  class="user-row"><label>'+i+'</label><em class="close ym" t="0"></em><em class="mb">'+("true"==a?"(mb)":"")+'</em><em class="wrtip">'+room.getWhUserCGTip(t,e)+"</em></span></li>"),room.setListScroll($(".visitorDiv .wh_tab_div"),{scrollbarPosition:"outside"});var n=$(".visitorDiv .wh_tab_ul li[uid="+o+"]");if(r){var l=n.find(".close"),u=parseInt(l.attr("t"))+1;l.attr("t",u).text(u).addClass("ym")}n.find(".close").click(function(){var t=$(this).parent().parent(),e=t.hasClass("on");t.remove(),$("#wh_msg_"+t.attr("uid")).remove();var o=$(".visitorDiv .wh_tab_ul li");e&&o.length>0&&o.eq(0).click(),0==o.length&&$(".visitorDiv .pub_tab_ul li").click()}),n.click(function(){$(".wh_msg_only").show(),$(".open_wh_box").is(":hidden")?($("#wh_msg_public,.right-teacher").addClass("dn"),$(".visitorDiv ul li").removeClass("on")):$(".visitorDiv .wh_tab_ul li").removeClass("on"),$(".wh_msg_only").children().addClass("dn"),$(this).addClass("on"),$(this).find(".close").attr("t",0).text("").removeClass("ym");var t=$(this).attr("uid"),e="wh_msg_"+t,o=$(this).attr("utype");if(0==$("#"+e).length){var i='<div id="'+e+'" class="wh-tab-msg" wid="newMsgShowBtn"><div class="wh-title"><span><label>'+$(this).find("label").text()+'</label>【<strong></strong>】</span><span class="title-tip"></span></div><div class="wh-content"></div><div class="wh-txt"><div class="toolbar"><a href="javascript:" class="facebtn">表情</a><label for="file_'+e+'" class="send-wh-img" title="发送图片"></label><input type="file" id="file_'+e+'" style="position:absolute;clip:rect(0 0 0 0);" class="fileBtn"/></div><div contenteditable="true" class="ctextarea" id="whTxt_'+t+'" data-placeholder="按回车键发送"></div></div></div>';$(".wh_msg_only").append(i),$("#"+e).find(".ctextarea").pastableTextarea().on("pasteImage",function(t,e){var o=$(this).find(".text-min-img");o.length>0?(o.attr("href",e.dataURL),o.find("img").attr("src",e.dataURL)):($(this).append('<a class="text-min-img" href="'+e.dataURL+'" data-lightbox="whSend-img"><img src="'+e.dataURL+'"/></a>'),$(this).focusEnd())}).keydown(function(t){if(13==t.keyCode)return room.sendWhMsg($(this)),!1}),$("#"+e).find(".facebtn").qqFace({id:"faceId_"+t,zIndex:1e6,assign:"whTxt_"+t,path:room.filePath+"/face/"}),$("#"+e).find(".fileBtn")[0].addEventListener("change",function(){var t=this,e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var o=e.size;if(o>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var i=new FileReader;i.readAsDataURL(e),i.onload=function(t){room.setUploadImg(t.target.result,room.getWhToUser())},i.onprogress=function(t){},i.onloadend=function(t){},$(this).val("")},!1),room.socket.emit("getWhMsg",{userType:room.userInfo.userType,groupId:room.userInfo.groupId,groupType:room.userInfo.groupType,userId:room.userInfo.userId,toUser:{userId:t,userType:o}})}else $("#"+e).removeClass("dn"),room.setTalkListScroll(!0,$("#"+e+" .wh-content"),"dark");room.widthCheck(),room.heightCalcu(),room.setWhOnlineTip(t,!$(this).hasClass("off"))})}},getWhBox:function(t){return $(".wh-middle #wh_msg_"+t)},setWhTipImgPlay:function(t){$("#userListId li[id="+t+"]").attr("k",1),room.whTipIntervalId=setInterval(function(){$("#userListId li[k=1]").toggleClass("have_op")},1e3)},closeWhTipMsg:function(t){$("#userListId li[id="+t+"]").attr("k",0).removeClass("have_op"),0==$("#userListId[k=1]").length&&room.whTipIntervalId&&clearInterval(room.whTipIntervalId)},fillWhBox:function(t,e,o,i,s,r){var a=$(".visitorDiv .wh_tab_ul li[uid="+o+"]"),n=this.getWhBox(o);if(0==n.length&&0==a.length)return room.setWhVisitors(t,e,o,i,!0,r),!1;if(0==a.length)return room.setWhVisitors(t,e,o,i,!0,r),!1;if(r&&!a.hasClass("on")){var l=a.find(".close"),u=parseInt(l.attr("t"))+1;return l.attr("t",u).text(u).addClass("ym"),!0}return!0},setWhContent:function(t,e,o){var i=t.fromUser,s="dialog whcontent ",r=t.content,a="",n="",l="";if(t.rule)return void $("#"+t.uiId+' span[contt="a"]').append('<em class="ruleTipStyle">'+t.value.tip+"</em>");if(o||(i.toWhUserId=i.userId),room.userInfo.userId==i.userId){if(e&&(i.publishTime=t.uiId,i.toWhUserId=i.toUser.userId,l='<em class="img-loading"></em>',n='<span class="shadow-box"></span><s class="shadow-conut"></s>'),t.serverSuccess){if($("#"+t.uiId+" .dtime").html(room.formatPublishTime(i.publishTime)),$("#"+t.uiId).attr("id",i.publishTime),t.content.msgType==room.msgType.img){room.removeLoadDom(i.publishTime);var u=$("#"+i.publishTime+" p"),m=t.content.needMax?"/admin/getBigImg?publishTime="+i.publishTime+"&userId="+i.userId:u.find("a img").attr("src");u.find("a[class=swipebox]").attr("href",m)}return}s+="mine",a='<span class="wh-dia-title"><label class="dtime">'+room.formatPublishTime(i.publishTime,o,"/")+'</label><label class="wh-nk">我</label></span>'}else{if(!o){room.tipSound(),room.setWhHistory(t);var d=this.fillWhBox(i.userType,i.clientGroup,i.userId,i.nickname,!0,!0);if(0==$(".visitorDiv .wh_tab_ul li[uid="+i.toWhUserId+"]").length&&$(".visitorDiv .wh_tab_ul").append($(".visitorDiv ul li[uid="+i.toWhUserId+"]")),!d)return}a='<span class="wh-dia-title"><label class="wh-nk">'+i.nickname+'</label><label class="dtime">'+room.formatPublishTime(i.publishTime,o,"/")+"</label></span>"}if(common.isBlank(i.toWhUserId))return void console.error("setWhContent->fromUser toWhUserId is null,please check!");var c="",p=$("#wh_msg_"+i.toWhUserId+" .wh-content"),h=p.find(".mCSB_container"),g="";r.msgType==room.msgType.img?(c=r.needMax?'<p><a href="/admin/getBigImg?publishTime='+i.publishTime+"&userId="+i.userId+'" class="swipebox"  data-lightbox="dialog-img"><img src="'+r.value+'" alt="图片"/></a>'+n+"</p>":'<p><a href="'+r.value+'" class="swipebox"  data-lightbox="dialog-img"><img src="'+r.value+'" alt="图片" /></a>'+n+"</p>",c+=l):(!e&&common.isValid(i.toUser.question)&&(g='<div class="dialog mine whcontent"><div><span class="wh-dia-title"><label class="dtime">'+room.formatPublishTime(i.toUser.publishTime,o,"/")+'</label><label class="wh-nk">我</label></span></div><div class="whblt">'+i.toUser.question+"</div></div>",h.length>0?h.append(g):p.append(g)),c='<p><span class="dcont" contt="a">'+r.value+"</span></p>"),g='<div class="'+s+'" id="'+i.publishTime+'" utype="'+i.userType+'" mType="'+r.msgType+'" t="header"><div style="margin-bottom:3px;">'+a+"</div>"+c+"</div>",h.length>0?h.append(g):p.append(g),this.formatMsgToLink(i.publishTime),o||room.setTalkListScroll(!0,p,"dark")},clearPasteImg:function(){$(".paste-img").is(":hidden")||$(".paste-img").hide().find("img").attr("src","").attr("h",120).attr("w",100)},setUploadImg:function(t,e){var o=e&&1==e.talkStyle,i=room.getUiId(),s={};common.copyObject(s,room.userInfo,!0),s.toUser=e;var r={uiId:i,fromUser:s,content:{msgType:room.msgType.img,value:"",needMax:0,maxValue:""}};o?(room.setWhHistory(r),room.setWhContent(r,!0,!1)):room.setContent(r,!0,!1),r.content.value=t,room.zipImg(r,100,60,function(t,e){if(t.error)return alert(t.error),$("#"+i).remove(),!1;var s=null;s=o?$("#"+t.uiId+" p .swipebox img"):$("#"+t.uiId+" span[contt=a] a[class=min_img] img"),s.attr("src",e).attr("needMax",t.content.needMax),room.dataUpload(t)})},zipImg:function(t,e,o,i){var s=new Image;s.onload=function(){var r=document.createElement("canvas");r||i({error:"发送图片功能目前只支持Chrome、Firefox、IE10或以上版本的浏览器！"});var a=s.width,n=s.height;if(n>=9*a)return i({error:"该图片高度太高，暂不支持发送！"}),!1;e>0&&(n>e||a>e)&&(t.content.needMax=1,n>e&&a<=e?(a*=e/n,n=e):(n*=e/a,a=e),s.height=n,s.width=a);var l=r.getContext("2d");r.width=a,r.height=n,l.clearRect(0,0,r.width,r.height),l.drawImage(s,0,0,a,n),i(t,r.toDataURL("image/jpeg",o/100))},s.src=t.content.value},dataUpload:function(t){var e=new XMLHttpRequest;e.open("POST","/admin/uploadData"),e.addEventListener("progress",function(e){if(e.lengthComputable){var o=(e.loaded/e.total*100|0)+"%";$("#"+t.uiId+" .shadow-box").css({height:"'+ra+'"}),$("#"+t.uiId+" .shadow-conut").html(o)}},!1),e.setRequestHeader("Content-Type","application/json; charset=utf-8"),e.onreadystatechange=function(){4===e.readyState&&200===e.status&&console.log("dataUpload success!")},t.fromUser.socketId=room.socket.id,e.send(JSON.stringify(t))},setEvent:function(){$(".openWhBoxBtn").click(function(){var t=$(".wh_out_div .wh_tab_ul li.on").attr("uid");$(".open_wh_box").is(":hidden")?($(this).hide(),$(".pub_tab_ul li").click(),$(".open_wh_box .visitorDiv").append($(".wh_out_div")),$(".open_wh_box .wh-middle").append($(".wh_msg_only")),$(".open_wh_box,.wh_msg_only").show(),$(".wh-history").css("float","right")):($(".local_box .visitorDiv").append($(".wh_out_div")),$(".local_box .wh-middle").append($(".wh_msg_only")),$(".open_wh_box").hide(),$(".local_box .openWhBoxBtn").show(),$(".wh-history").css("float","left")),room.widthCheck(),room.heightCalcu(),common.isValid(t)?$(".wh_out_div .wh_tab_ul li[uid="+t+"]").click():$(".wh_out_div .wh_tab_ul li:first").click()}),$(".open_wh_box").draggable({handle:".box_title",cursor:"move",containment:"document",scroll:!1}).resizable({minWidth:550,minHeight:450,maxWidth:1600,maxHeight:900}),$(".open_wh_box").resize(function(t){room.widthCheck(),room.heightCalcu()});var t=$("#groupInfoId"),e=t.attr("awr"),o=t.attr("aw");if("true"==o&&common.containSplitStr(e,room.userInfo.userType)&&$(".wh_out_div").removeClass("dn"),$(".pub_tab_ul li").click(function(){$(".open_wh_box").is(":hidden")&&($(".visitorDiv li").removeClass("on"),$(".wh_msg_only").hide()),$(this).addClass("on"),$("#wh_msg_public,.right-teacher").removeClass("dn"),room.widthCheck(),room.setTalkListScroll(!0)}),$("#publish_point").click(function(){$("#userListId li").removeClass("zin"),$(".point-list").addClass("dn"),$(".right-teacher .publish-point").removeClass("dn"),$(".point-list .point-list-content ul li .cancel-btn").click()}),$(".right-teacher .publish-point .publish-close,.right-teacher .point-list .point-close").click(function(){$(".right-teacher .publish-point,.right-teacher .point-list").addClass("dn"),$(".point-list .point-list-content ul li .cancel-btn").click()}),$(".publish-point .publish-btn").click(function(){$(this).attr("disabled","disabled"),room.publishViewPoint()}),$("#point_list").click(function(){$("#userListId li").removeClass("zin"),$(".right-teacher .publish-point").addClass("dn"),$(".point-list").removeClass("dn"),room.getArticleList("trade_strategy_article",room.userInfo.groupId,1,1,20,'{"createDate":"desc"}',room.userInfo.userId,function(t){var e=t.data.length,o="";if($(".point-list .point-list-content ul").html(""),t&&0==t.result&&t.data&&e>0){var i="",s=room.formatHtml("point-list");$.each(t.data,function(t,r){var a=r.detailList[0];t+1==e&&(o=' class="last"'),i+=s.formatStr(o,r._id,a.title,common.formatterDateTime(r.publishStartDate),common.formatterDateTime(r.publishEndDate),a.content)}),$(".point-list .point-list-content ul").html(i),room.teacherPointEdit(".point-list .point-list-content ul li .edit-btn",".point-list .point-list-content ul li .save-btn",".point-list .point-list-content ul li .cancel-btn"),room.setListScroll(".point-list .point-list-content",{scrollbarPosition:"outside"})}})}),$(".clearbtn").click(function(){$("#dialog_list").html(""),room.setTalkListScroll()}),$(".scrollbtn").click(function(){$(this).hasClass("on")?$(this).removeClass("on"):($(this).addClass("on"),room.setTalkListScroll(!0))}),$("#approveAllHandler button").click(function(){var t=[],e=[];return $("#dialog_list .approve input:checked").each(function(){var o=$(this).parents("div");t.push(o.attr("id"));for(var i=o.attr("fuId"),s=!1,r=0,a=e.length;r<a;r++)if(i===e[r]){s=!0;break}s||e.push(i)}),0==t.length?(alert("请选择聊天记录！"),!1):void room.socket.emit("approvalMsg",{fromUser:room.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),$("#approveCheckAll").click(function(){var t=$(this).prop("checked");$("#dialog_list .approve input[type=checkbox]").each(function(){$(this).prop("checked",t)})}),$("#close-top-box").click(function(){$(".top-box").addClass("dn")}),$("#show_top_btn").click(function(){$(".top-box").toggleClass("dn")}),$(document).click(function(t){$("div[id^=faceId]").hide(),$(t.target).hasClass("headimg")||$(t.target).parent().hasClass("headimg")||"header"==$(t.target).parent().attr("t")||$(t.target).hasClass("uname")||$(".dialogbtn").hide(),$(t.target).hasClass("searchResult")||$(".searchResult").hide()}),$(".facebtn").qqFace({id:"faceId",assign:"whTxt",path:room.filePath+"/face/"}),$(".replybtn").click(function(){room.setDialog(null,$(this).attr("uid"),$(".sender").html(),$(this).attr("ts"),$(this).attr("utype"),$(this).attr("tm"),$(this).parent().find(".xcont").html()),$(".mymsg em").show()}),$(".closebtn").click(function(){$(".mymsg,.mymsg em").hide()}),$("#vSearchTxt").keydown(function(t){13==t.keyCode&&room.getVisitorList(this.value)}),$("#vSearchTxtBtn").click(function(){room.getVisitorList($("#vSearchTxt").val())}),$("#wh_msg_public").find(".fileBtn")[0].addEventListener("change",function(){var t=this,e=t.files[0];if(!e)return!1;if(0!=e.type.indexOf("image")||!e.type||!/\.(?:jpg|png|gif)$/.test(e.name.toLowerCase()))return alert("目前暂支持jpg,gif,png格式的图片！"),!1;var o=e.size;if(o>=5242880)return alert("发送的图片大小不要超过5MB."),!1;var i=new FileReader;i.readAsDataURL(e),i.onload=function(t){room.setUploadImg(t.target.result,null)},i.onprogress=function(t){},i.onloadend=function(t){},$(this).val("")},!1),$("#wh_msg_public #whTxt").pastableTextarea().on("pasteImage",function(t,e){var o=$(this).find(".text-min-img");o.length>0?(o.attr("href",e.dataURL),o.find("img").attr("src",e.dataURL)):($(this).append('<a class="text-min-img" href="'+e.dataURL+'" data-lightbox="send-img"><img src="'+e.dataURL+'"/></a>'),$(this).focusEnd())}).keydown(function(t){var e=$(this).html();if(13==t.keyCode){if($(this).html(e.replace(/<div>|<\/div>/g,"")),$(".ui-autocomplete").is(":hidden")){var o=room.getToUser(),i=$("#wh_msg_public #whTxt .text-min-img img");if(i.size()>0){var s=i.attr("src");s.length>1048576?alert("发送的图片大小不要超过1MB."):(room.setUploadImg(s,o),i.remove())}var r=room.getSendMsg();if(r===!1)return $("#whTxt").html(""),!1;var a={uiId:room.getUiId(),fromUser:room.userInfo,content:{msgType:room.msgType.text,value:r}},n=$(".replybtn");o&&o.userId==n.attr("uid")&&0==o.talkStyle&&$(".mymsg,.mymsg em").hide(),a.fromUser.toUser=o,room.socket.emit("sendMsg",a),room.setContent(a,!0,!1),$("#whTxt").html("");var l={groupId:room.userInfo.groupId,mobile:room.userInfo.mobilePhone,clientGroup:"",userName:room.userInfo.nickname,roomName:decodeURI(common.getUrlParam("roomName",!0)),userSource:"web",useEquipment:"",tradingAccount:"",tradingPlatform:"",platformType:0,groupType:room.userInfo.groupType,operateEntrance:"",operationType:2,visitorId:"",sid:room.userInfo.sid,nickname:room.userInfo.nickname,email:"",videoId:"",videoName:"",courseId:"",courseName:"",teacherId:"",teacherName:""};1==room.userInfo.userType?l.clientGroup="admin":2==room.userInfo.userType?l.clientGroup="analyst":3==room.userInfo.userType&&(l.clientGroup="cs"),chatAnalyze.setUTM(!1,l)}return!1}if(8==t.keyCode){var u=$(this).find(".txt_dia");if($.trim($(this).text())==u.text())return u.remove(),$(this).html(""),!0}}).autocomplete({source:function(t,e){/^@.*$/g.test(t.term)&&e(room.searchUserList(t.term.substring(1,t.term.length)))},delay:500,minLength:2,position:{my:"left bottom",at:"left top"},select:function(t,e){return $("#whTxt").html("").append('<span class="txt_dia" contenteditable="false" uid="'+e.item.value+'" utype="'+e.item.userType+'">@<label>'+e.item.label+"</label></span>&nbsp;").focusEnd(),!1}}).autocomplete("instance")._renderItem=function(t,e){return $("<li>").append("<a>"+e.label+"</a>").appendTo(t)},$(".right-teacher .teacher .open-video").click(function(){$(".video").removeClass("dn")}),$(".video .video-close").click(function(){$(".video").addClass("dn")}),$(".video").draggable({handle:".close-title"}).resizable({minWidth:450,minHeight:420,maxWidth:1024,maxHeight:900}),$(".video").resize(function(t){$(this).find(".mod_video").height($(this).height()-40)}),$(".not-talk .talk-title .talk-close,#btnCantTalkCancel").click(function(){$(".not-talk").addClass("dn")}),$("#btnCantTalk").click(function(){var t=room.getUserGagData();room.setUserGag(t.set,t.visitor)}),!store.enabled)return void console.log("Local storage is not supported by your browser.");if(room.tipSoundObj.storageObj=store.get(room.tipSoundObj.key),common.isBlank(room.tipSoundObj.storageObj)){var i={turn:"on"};store.set(room.tipSoundObj.key,i)}else"on"==room.tipSoundObj.storageObj.turn?$(".wh_out_div .tip-sound").removeClass("off"):$(".wh_out_div .tip-sound").addClass("off");$(".wh_out_div .tip-sound").click(function(){var t=room.tipSoundObj.storageObj=store.get(room.tipSoundObj.key),e={};common.isBlank(t)?e.turn="on":e=t,$(this).hasClass("off")?($(this).removeClass("off"),e.turn="on"):($(this).addClass("off"),e.turn="off"),store.set(room.tipSoundObj.key,e)}),$(".rightTitle a").click(function(){$(".onlineSearch").hasClass("dn")?$(".onlineSearch").removeClass("dn"):($(".onlineSearch").addClass("dn"),$("#userListId li").show(),$("#onlineSearchTxt").val("")),room.heightCalcu(),room.setListScroll(".user_box")}),$("#onlineSearchTxt").keydown(function(t){13==t.keyCode&&room.searchUser($(this).val())}),$("#onlineSearchTxtBtn").click(function(){room.searchUser($("#onlineSearchTxt").val())}),room.articleNote.setArticleNoteEvent(),$(".wh-history").click(function(){room.fillWhHistory(),$(".wh_tab_history_div").removeClass("dn")}),$("#wh_close").click(function(){return $(".wh_tab_history_div").addClass("dn"),!1})},articleNote:{articleEditor:null,setArticleNoteEvent:function(){var t=$("#publish_note");0!=t.size&&($("#publish_note_content").append('<script id="article_note_editor" name="content" type="text/plain" style="width:auto;height:auto;"></script>'),this.articleEditor=UE.getEditor("article_note_editor",{serverUrl:room.apiUrl+"/upload/editorUpload",customDomain:!0,initialFrameWidth:"100%",initialFrameHeight:"200"}),$("#publish_note").click(function(){$("#userListId li").removeClass("zin"),room.articleNote.articleEditor.execCommand("cleardoc"),$(".right-teacher .publish-note").show()}),$(".right-teacher .publish-note .publish-close").click(function(){$(".right-teacher .publish-note").hide()}),$(".publish-note .publish-btn").click(function(){$(this).prop("disabled",!0),room.articleNote.saveArticleNote()}))},saveArticleNote:function(){var t=this.articleEditor.getContent();if(t=this.filterContent(t),!t)return room.showTipBox("笔记内容为空！"),void $(".publish-note .publish-btn").prop("disabled",!1);var e=room.apiUrl+"/common/getCourse?flag=S&groupType="+room.userInfo.groupType+"&groupId="+room.userInfo.groupId;$.getJSON(e,function(e){if(e&&"0"==e.result&&e.data&&e.data.length>0&&!e.data[0].isNext){var o=e.data[0],i=common.formatterDate(o.date,"-"),s={template:"note",category:"class_note",platform:room.userInfo.groupId,publishStartDate:i+" "+o.startTime+":00",publishEndDate:i+" "+o.endTime+":00",mediaUrl:"",mediaImgUrl:"",linkUrl:"",detailList:[{lang:"zh",title:o.title,content:t,authorInfo:{userId:o.lecturerId,name:o.lecturer,avatar:o.avatar,position:""}}]};common.getJson("/admin/addArticle",{data:JSON.stringify(s),isNotice:"Y"},function(t){t.isOK?t.id?(room.showTipBox("发布课堂笔记成功！"),$(".right-teacher .publish-note .publish-close").click()):room.showTipBox("发布课堂笔记失败！"):room.showTipBox(t.msg),$(".publish-note .publish-btn").prop("disabled",!1)})}else room.showTipBox("未找到相应课程信息！"),$(".publish-note .publish-btn").prop("disabled",!1)})},filterContent:function(t){var e="";return t&&(e=t.replace(/[\r\n]/g,""),e=e.replace(/(<p>(\s*<br\/?>\s*)*<\/p>)*$/g,"")),e}},searchUserList:function(t){var e=$("#userListId li[t!=14][t!=0]").map(function(){var e=$(this).find(".uname").text();return e.indexOf(t)!=-1?{value:this.id,label:e,userType:$(this).attr("utype")}:null}).get();return e},getSendMsg:function(t){var t=t?t:$("#whTxt"),e=t.find(".txt_dia");t.find(".txt_dia").length>0&&(room.setTalkTop(!1,{publishTime:e.attr("tm")}),t.find(".txt_dia").remove());var o=common.clearMsgHtml(t.html());return common.isBlank(o)?(t.html(""),!1):o},setListScroll:function(t,e){$(t).hasClass("mCustomScrollbar")?$(t).mCustomScrollbar("update"):(e=$.extend({scrollButtons:{enable:!0},theme:"dark"},e),$(t).mCustomScrollbar(e))},setTalkListScroll:function(t,e,o){var i=e?e:$("#chatMsgContentDiv");i.hasClass("mCustomScrollbar")?(i.mCustomScrollbar("update"),t&&i.mCustomScrollbar("scrollTo","bottom")):(i.mCustomScrollbar({scrollInertia:1,scrollButtons:{enable:!0},theme:o?o:"light-2"}),i.mCustomScrollbar("scrollTo","bottom"))},getToUser:function(){var t=$("#whTxt .txt_dia");if(t.length>0){var e={userId:t.attr("uid"),nickname:t.find("label").text(),talkStyle:0,userType:t.attr("utype")},o=t.find("input");return o.length>0&&(e.question=o.val()),e}return null},formatPublishTime:function(t,e,o){var i=Number(t.replace(/_.+/g,""));return common.isBlank(t)?"":e?common.formatterDateTime(i,o):common.getHHMM(i)},setDialog:function(t,e,o,i,s,r,a){if(1==i)room.fillWhBox(s,t,e,o,!1),room.getWhBox(e).removeClass("dn"),$(".visitorDiv ul li[uid="+e+"]").click();else if(3==i)if($(".not-talk .talk-title span").text("设置禁言【用户："+o+"；房间："+$("title").text()+"】"),$("#userGagForm input[name='utype']").val(s),$("#userGagForm input[name='memberId']").val(e),$("#userGagForm input[name='groupId']").val(room.userInfo.groupId),$("#userGagForm input[name='groupType']").val(room.userInfo.groupType),0==s)room.initGagDate(),$(".not-talk").removeClass("dn");else{$("#userGagForm input[name='memberId']").val(o);var n=room.getUserGagData();n.set.type="visitor_filter",$(".not-talk").addClass("dn"),room.setUserGag(n.set,n.visitor)}else{$("#whTxt .txt_dia").remove(),$("#whTxt").html($("#whTxt").html().replace(/^((&nbsp;)+)/g,""));var l="";if(a){l='<input type="hidden" value="">';var u=$("<div>"+a+"</div>");u.find(".txt_dia").remove(),a=u.html()}var m=$('<span class="txt_dia" contenteditable="false" uid="'+e+'" tm="'+r+'" utype="'+s+'">'+l+"@<label>"+o+"</label></span>");m.find("input").val(a),$("#whTxt").prepend("&nbsp;").prepend(m).focusEnd(),$("#talk_top_id .ss-tk-info[tm="+r+"]").find("strong").addClass("reply-st")}},setContent:function(t,e,o){var i=t.fromUser;t.content;if(e&&(i.publishTime=t.uiId),o&&$("#"+i.publishTime).length>0)return $("#"+i.publishTime+" span[contt] em[class=ruleTipStyle]").remove(),void $("#"+i.publishTime+" .approve").remove();if(t.rule)return void(t.value&&t.value.needApproval?$("#"+t.uiId).attr("id",i.publishTime):$("#"+t.uiId+' span[contt="a"]').append('<em class="ruleTipStyle">'+t.value.tip+"</em>"));if(!e&&room.userInfo.userId==i.userId&&t.serverSuccess){if($("#"+t.uiId+" .dtime").html(room.formatPublishTime(i.publishTime)),$("#"+t.uiId).attr("id",i.publishTime),t.content.msgType==room.msgType.img){room.removeLoadDom(i.publishTime);var s=$("#"+i.publishTime+" span[contt=a] a[class=min_img]"),r=t.content.needMax?"/admin/getBigImg?publishTime="+i.publishTime+"&userId="+i.userId:s.children("img").attr("src");s.attr("href",r)}return void this.removeTalkMsg(i.publishTime)}var a=room.formatContentHtml(t,e,o),n=$("#dialog_list");n.append(a),this.formatMsgToLink(i.publishTime);$(".view_select .selectlist a[class=on]").attr("t");!o&&$(".scrollbtn").hasClass("on")&&room.setTalkListScroll(!0),$("#"+i.publishTime+" .headimg").click(function(){var t=$(this).parent(),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),room.openDiaLog(e)}),$("#"+i.publishTime+" .uname").click(function(){var t=$(this).parent().parent(),e=t.find(".dialogbtn");e.attr("tm",t.attr("id")),room.openDiaLog(e),e.css("left","62px")}),$("#"+i.publishTime+" .txt_dia").click(function(){room.setDialog(null,$(this).attr("uid"),$(this).find("label").text(),0,$(this).attr("utype"))}),$("#"+i.publishTime+" .approve button").click(function(){var t=[],e=[],o=$(this).parents("div");t.push(o.attr("id")),e.push(o.attr("fuId")),room.socket.emit("approvalMsg",{fromUser:room.userInfo,status:$(this).attr("btnType"),publishTimeArr:t,fuIdArr:e})}),this.removeTalkMsg(i.publishTime)},removeTalkMsg:function(t){t.indexOf("_ms")==-1&&$("#"+t+" p .close").click(function(){if(confirm("确定删除该记录？")){var e={publishTimeArr:[t],groupId:room.userInfo.groupId};common.getJson("/admin/removeMsg",{data:JSON.stringify(e)},function(t){null!=t&&t.isOK?room.showTipBox("删除聊天记录成功！"):room.showTipBox("删除聊天记录失败！")})}})},openDiaLog:function(t){$(".dialogbtn").not(t).hide(),t.css("left","0");
var e=t.parent();if(common.isValid(e.attr("utype"))){var o=0===e.next().size(),i=$("#userListId li").size();if(t.parent().hasClass("analyst"))t.css("top",o?"-67px":"53px");else if(1==i&&e.is("ul"))$("#userListId").css("margin-bottom","55px"),t.css("top","0px");else if(e.is("div")){var s=t.find("a").size();3===s?t.css({top:o?"-90px":"35px",left:"5px"}):4===s?t.css({top:o?"-120px":"10px",left:"5px"}):t.css({top:o?"-60px":"35px",left:"5px"})}else $("#userListId").css("margin-bottom","25px"),t.css("top",o?"12px":"39px")}return t.is(":hidden")?(t.show(),void("true"!=t.attr("sk")&&t.attr("sk","true").find("a").click(function(){var t=$(this).parent(),e="",o=$(this).attr("t");if("2"==o){o=0;var i=t.prev().find("span[contt='a']"),s=i.find("a[data-lightbox]").html();common.isValid(s)&&i.find("span:last").html(s),e=i.html()}room.setDialog(t.attr("cg"),t.attr("uId"),t.attr("nk"),o,t.attr("utype"),t.attr("tm"),e),t.hide()}))):(t.hide(),!1)},formatContentHtml:function(t,e,o){var i="dialog ",s="",r="",a="",n="",l="uname ",u="false",m=t.fromUser,d=t.content,c=m.nickname,p=m.toUser,h="";p&&common.isValid(p.userId)&&(h='<span class="txt_dia" uid="'+p.userId+'" utype="'+p.userType+'">@<label>'+p.nickname+"</label></span>",room.userInfo.userId==p.userId&&(u="true")),s=d.value,room.userInfo.userId==m.userId?(e&&(m.publishTime=t.uiId,a='<em class="img-loading"></em>',r='<span class="shadow-box"></span><s class="shadow-conut"></s>'),i+="mine",c="我",u="true"):(2==m.userType&&(i+="analyst"),1==m.userType&&(i+="admin"),3==m.userType&&(i+="cs"),n=room.getDialogHtml(m.clientGroup,m.userId,c,m.userType,m.isMobile,!0),!o&&p&&room.userInfo.userId==p.userId&&room.setTalkTop(!0,t));var g="";d.msgType==room.msgType.img?(g='style="display:block;max-width:150px;"',s=d.needMax?"<span "+g+'><a href="/admin/getBigImg?publishTime='+m.publishTime+"&userId="+m.userId+'" data-lightbox="dialog-img"><img src="'+d.value+'" alt="图片"/></a>'+r+"</span>":"<span "+g+'><a href="'+d.value+'" class="min_img" data-lightbox="dialog-img"><img src="'+d.value+'" alt="图片" /></a>'+r+"</span>",s+=a):s=d.value;var f='<div class="'+i+'" id="'+m.publishTime+'" isMe="'+u+'" utype="'+m.userType+'" mType="'+d.msgType+'" t="header"><a href="javascript:" class="headimg" uId="'+m.userId+'">'+room.getUserAImgCls(m.clientGroup,m.userType,m.avatar)+'</a><i></i><p><a href="javascript:"  class="'+l+'">'+c+'</a><span class="dtime">'+room.formatPublishTime(m.publishTime)+'</span><a href="javascript:void(0);" class="close"></a>';return 0==d.status&&(f+='<span class="approve"><input type="checkbox"/><button btnType="1">通过</button><button btnType="2">拒绝</button></span>',$("#approveAllHandler").show()),f+=p&&common.isValid(p.question)?'<span class="dcont"><span uid="'+p.userId+'" utype="'+p.userType+'">'+p.nickname+'</span>提问：<span contt="q">'+p.question+'</span><span class="dialog_reply">回复：<span contt="a">'+s+"</span></span>":'<span class="dcont" contt="a">'+h+s+"</span>",f+="</span></p>"+n+"</div>"},formatMsgToLink:function(t){$("#"+t+' span[contt]:contains("http:"),#'+t+' span[contt]:contains("https:")').each(function(t,e){var o=$(e).html(),i=o.split(/<img[^>]*>|<a[^>]*>.*?<\/a>/g),s="";for(var r in i)if(s=i[r],!common.isBlank(s)){var a=s.replace(/(http:\/\/|https:\/\/)((\w|=|\?|\.|\/|\\&|-)+)(:\d+)?(\/|\S)+/g,function(t){return'<a href="'+t+'" target="_blank" style="color:#3181c6;">'+t+"</a>"});e.innerHTML=e.innerHTML.replace(s,a)}})},removeLoadDom:function(t){$("#"+t+" .img-loading,#"+t+" .img-load-gan,#"+t+" .shadow-box,#"+t+" .shadow-conut").remove()},getUserAImgCls:function(t,e,o){var i="";return e&&0!=e&&common.isValid(o)?'<img src="'+o+'">':(i="vip"==t?"user_v":"active"==t||"notActive"==t?"user_r":"simulate"==t?"user_d":"register"==t?"user_m":"user_c",'<img src="/admin/img/'+i+'.png">')},getDialogHtml:function(t,e,o,i,s,r){if(room.userInfo.userId!=e&&room.userInfo.userId.indexOf("visitor_")==-1){var a=$("#groupInfoId"),n=[],l="d2";return n.push('<div class="dialogbtn" style="display:none;" cg="'+t+'" nk="'+o+'" uId="'+e+'" utype="'+i+'">'),n.push('<a href="javascript:" class="d1" t="0"><span>@TA</span></a>'),"true"==a.attr("aw")&&common.containSplitStr(a.attr("awr"),room.userInfo.userType)&&(l=i<=0||r?"d1":"d2",n.push('<a href="javascript:" class="'+l+'" t="1"><span>私聊</span></a>')),r&&(l=i<=0?"d1":"d2",n.push('<a href="javascript:" class="'+l+'" t="2"><span>回复</span></a>')),i<=0&&n.push('<a href="javascript:" class="d3" t="3"><span>禁言</span></a>'),n.length>1?n.join("")+"</div>":""}return'<div class="dialogbtn" style="display:none;" cg="'+t+'" nk="'+o+'" uId="'+e+'" utype="'+i+'"></div>'},getOnlineUserDom:function(t){var e={notActive:"(N)",active:"(A)"},o=room.getDialogHtml(t.clientGroup,t.userId,t.nickname,t.userType,t.isMobile,!1),i="",s=t.sequence,r=common.isBlank(e[t.clientGroup])?"":e[t.clientGroup],a=t.isMobile?'<em class="mb-cls">(mb)'+r+"</em>":'<em class="mb-cls">'+r+"</em>";return room.userInfo.userId==t.userId&&(i="【我】",s=0),{isMe:common.isValid(i),hasDg:common.isValid(o),dom:'<li id="'+t.userId+'" t="'+s+'" utype="'+t.userType+'"  ismb="'+t.isMobile+'">'+o+'<a href="javascript:" t="header" class="uname"><div class="headimg">'+room.getUserAImgCls(t.clientGroup,t.userType,t.avatar)+'</div><label class="nk-lb">'+t.nickname+i+"</label>"+a+"</a></li>"}},setOnlineUser:function(t){2==t.userType&&($(".teacher .te_l").attr("uid",t.userId),$(".teacher .te_l img").attr("src",t.avatar),$(".teacher .te_l div span").text(t.nickname),$(".teacher .btn").removeClass("dn")),$("#userListId li[id='"+t.userId+"']").remove();var e=$("#userListId li"),o=this.getOnlineUserDom(t),i=o.dom;if(0==e.length)$("#userListId").append(i);else if(o.isMe)e.first().before(i);else{var s=!1,r=0,a="";e.each(function(){return r=parseInt($(this).attr("t")),t.sequence<r?($(this).before(i),s=!0,!1):t.sequence==r&&(a=$(this).find("a").text(),t.nickname<=a)?($(this).before(i),s=!0,!1):void 0}),s||$("#userListId").append(i)}return o.hasDg&&this.setUserListClick($("#userListId li[id="+t.userId+"] a[t=header]")),!0},setUserListClick:function(t){t.click(function(){if("0"==$(this).parent().attr("t"))$("#userListId li").removeClass("zin"),$(".dialogbtn").hide();else{var t=$(this).parent();$(".dialogbtn").hide(),$("#userListId li").removeClass("zin"),t.addClass("zin"),room.openDiaLog($(this).prev()),$(".dialogbtn",$(this).parent()).css("left","7px")}}).dblclick(function(){$(this).prev(".dialogbtn").find("a[t=1]").trigger("click")})},leaveRoomTip:function(t,e){if("visitor"!=room.userInfo.clientGroup){var o="";if("roomClose"==t&&(o="房间已停用，"),"otherLogin"==t&&(o="您的账号已在其他地方进入该房间，"),"forcedOut"==t){alert(e+room.userInfo.userId);var i=e?e.length:0;if(i>0){for(var s=0,i=e?e.length:0;s<i&&e[s]!=room.userInfo.userId;s++);if(s==i)return}o="您已被管理员强制退出房间，"}$("#tipMsgBox").fadeIn(0).delay(6e3).fadeOut(200).find("span").text("注意："+o+"正自动退出....."),window.setTimeout(function(){window.close()},3e3)}},setSocket:function(){this.socket=common.getSocket(io,this.socketUrl,this.userInfo.groupType),this.socket.on("connect",function(){console.log("connected to server!"),room.userInfo.socketId=room.socket.id;var t=$("#groupInfoId");room.socket.emit("login",{userInfo:room.userInfo,lastPublishTime:$("#content_ul li:last").attr("id"),fUserTypeStr:t.attr("awr"),allowWhisper:t.attr("aw")}),$(".img-loading[pf=chatMessage]").show()}),this.socket.on("onlineUserList",function(t,e){$("#userListId").html("");var o=null,i=[];for(var s in t)o=t[s],2==o.userType?room.setOnlineUser(o):i.push(room.getOnlineUserDom(o).dom);$("#userListId").append(i.join("")),room.setUserListClick($("#userListId li a[t=header]")),$("#onLineSizeNum").text($("#userListId li").length),room.setListScroll(".user_box")}),this.socket.on("disconnect",function(t){console.log("disconnect")}),this.socket.on("error",function(t){console.error("e:"+t)}),this.socket.on("sendMsg",function(t){if(common.isBlank(t.fromUser.toUser)||1!=t.fromUser.toUser.talkStyle){if(!t.serverSuccess&&room.userInfo.userId==t.fromUser.userId&&!t.rule)return;room.setContent(t,!1,!1)}else room.setWhContent(t,!1,!1),room.userInfo.userId!=t.fromUser.userId&&(room.setTaskBarNotice(t),room.setDesktopNotice(t))}),this.socket.on("notice",function(t){switch(t.type){case"onlineNum":var e=t.data,o=e.onlineUserInfo;if(e.online)room.setOnlineUser(o);else if(room.userInfo.userId!=o.userId&&($("#userListId #"+o.userId).remove(),room.setListScroll(".user_box")),2==o.userType){var i=$(".teacher .te_l[uid="+o.userId+"]");i.find("img").attr("src",""),i.find("div span").text("老师暂未上线")}$("#onLineSizeNum").text($("#userListId li").length),room.setWhOnlineTip(o.userId,e.online,o);break;case"removeMsg":$("#"+t.data.replace(/,/g,",#")).remove(),room.setTalkListScroll();break;case"leaveRoom":room.leaveRoomTip(t.flag,t.userIds);break;case"approvalResult":var e=t.data;if(e.fromUserId==room.userInfo.userId)if(e.isOK){var s=e.publishTimeArr;if(2==e.status){for(var r in s)$("#"+s[r]).remove();room.setTalkListScroll()}else for(var r in s)$("#"+s[r]+" .approve").remove();$("#approveCheckAll").prop("checked",!1),0==$("#dialog_list .approve").size()&&$("#approveAllHandler").hide()}else alert("操作出现异常，请重新执行！");else if(e.refuseMsg){var s=e.publishTimeArr;for(var r in s)$("#"+s[r]).remove();room.setTalkListScroll()}else{for(var r in e)room.formatUserToContent(e[r]);room.setTalkListScroll(!0)}}}),this.socket.on("loadMsg",function(t){$(".img-loading[pf=chatMessage]").hide();var e=t.msgData,o=t.isAdd;if(o||$("#content_ul").html(""),e&&$.isArray(e)){e.reverse();for(var i in e){var s=e[i];s.content.status=s.status,room.formatUserToContent(s)}room.setTalkListScroll(!0)}}),this.socket.on("loadWhMsg",function(t){var e=t.data;if("offline"==t.type){if(e&&!$.isEmptyObject(e)){var o="";for(var i in e)o=i,room.setWhVisitors(e[i].userType,e[i].clientGroup,i,e[i].nickname,$("#userListId li[id='"+i+"']").length>0)}}else if(e&&$.isArray(e)){var s=0,r=null;e.reverse();for(var a in e)r=e[a],room.formatUserToContent(r,!0,t.toUserId),r.content.msgType==room.msgType.img&&s++;room.setTalkListScroll(!0,$("#wh_msg_"+t.toUserId+" .wh-content"),"dark")}})},formatUserToContent:function(t,e,o){var i={userId:t.userId,nickname:t.nickname,avatar:t.avatar,userType:t.userType,groupId:t.groupId,clientGroup:t.clientGroup,publishTime:t.publishTime,toUser:t.toUser,avatar:t.avatar};e?(i.toWhUserId=o,room.setWhContent({fromUser:i,content:t.content},!1,!0)):room.setContent({fromUser:i,content:t.content},!1,!0)},hideMsg:function(){$("#popMsgBox").is(":visible")&&$("#popMsgBox").fadeOut("normal","swing",function(){$(".blackbg").hide()})},showTipBox:function(t){$(".tipsbox").fadeIn().delay(1e3).fadeOut(200).find(".cont").text(t)},showMsg:function(t){"string"==typeof t&&(t={msg:t}),t=$.extend({closeable:!0,title:"",msg:"",modal:!0,delay:0,btns:[{txt:"确定",fn:function(){room.hideMsg()}}]},t),$("#popMsgTit").text(t.title||""),$("#popMsgTxt").html(t.msg);var e=$("#popMsgCont");e.find("a.yesbtn").remove();for(var o=null,i=null,s=0,r=t.btns?t.btns.length:0;s<r;s++)o=t.btns[s],i=$('<a class="yesbtn" href="javascript:void(0)">'+o.txt+"</a>"),e.append(i),i.click(o.fn);t.closeable?$("#popMsgClo").show():$("#popMsgClo").hide(),$("#popMsgBox").show(),t.modal&&$(".blackbg").show(),t.delay&&window.setTimeout(function(){room.hideMsg()},t.delay)},publishViewPoint:function(){var t=$("#title").val(),e=$("#publishStartDateStr").val(),o=$("#publishEndDateStr").val(),i=$("#content").val();if(common.isBlank(t))return void room.showTipBox("请输入标题");if(common.isBlank(e))return void room.showTipBox("请输入发布开始时间");if(common.isBlank(o))return void room.showTipBox("请输入发布结束时间");if(common.isBlank(i))return void room.showTipBox("请输入需要发布的内容!");var s={category:"trade_strategy_article",platform:room.userInfo.groupId,publishStartDate:e,publishEndDate:o,mediaUrl:"",mediaImgUrl:"",linkUrl:"",detailList:[{lang:"zh",title:t,content:i,authorInfo:{userId:room.userInfo.userId,name:room.userInfo.nickname,avatar:room.userInfo.avatar,position:room.userInfo.position}}]};common.getJson("/admin/addArticle",{data:JSON.stringify(s)},function(t){t.isOK?t.id>0?(room.showTipBox("观点发布成功！"),$(".right-teacher .publish-point .publish-close").click(),$('.right-teacher .publish-point input[type="text"],.right-teacher .publish-point textarea').val("")):room.showTipBox("观点发布失败！"):room.showTipBox(t.msg),$(".publish-point .publish-btn").removeAttr("disabled")})},initGagDate:function(){var t=room.getUserGagData();$("#userGag_gagDate_div").empty();var e=common.formatterDate(new Date,"-");common.getJson("/admin/getUserGag",{data:JSON.stringify(t.set)},function(t){if(t){var o=t.gagDate;o=common.isBlank(o)?{beginDate:e,endDate:e,weekTime:[{week:"",beginTime:"00:00:00",endTime:"23:59:59"}]}:JSON.parse(o),$("#userGag_gagDate_div").dateTimeWeek({data:o}),$("#userGagForm input[name=gagTips]").val(t.gagTips),$("#userGagForm input[name=gagRemark]").val(t.gagRemark)}else{var o={beginDate:e,endDate:e,weekTime:[{week:"",beginTime:"00:00:00",endTime:"23:59:59"}]};$("#userGag_gagDate_div").dateTimeWeek({data:o})}})},getUserGagData:function(){$("#userGag_gagDate").val($("#userGag_gagDate_div").dateTimeWeek("getData"));var t=$.trim($("#userGag_gagDate").val()),e=$.trim($("#userGagForm input[name=groupType]").val()),o=$.trim($("#userGagForm input[name=memberId]").val()),i=$.trim($("#userGagForm input[name=groupId]").val()),s=$.trim($("#userGagForm input[name=gagTips]").val()),r=$.trim($("#userGagForm input[name=gagRemark]").val()),a={groupType:e,groupId:i,userId:o,gagDate:t,gagTips:s,gagRemark:r},n=0!=$.trim($("#userGagForm input[name=utype]").val());return{set:a,visitor:n}},setUserGag:function(t,e){common.getJson("/admin/setUserGag",{data:JSON.stringify(t),isvisitor:e},function(t){e?$("#userListId li div.dialogbtn").hide():$(".not-talk").addClass("dn"),t.isOK?room.showTipBox("设置禁言成功！"):room.showTipBox("设置禁言失败："+t.msg)})},setDesktopNotice:function(t){if(room.nwWin&&room.nwIsMinimize)try{room.nwTray.tooltip=room.roomName,this.desktopNotice?this.desktopNotice.update({type:"info",text:t.fromUser.nickname+"："+t.content.value,icon:t.fromUser.avatar}):(PNotify.desktop.permission(),this.desktopNotice=new PNotify({title:"新消息",text:t.fromUser.nickname+"："+t.content.value,desktop:{desktop:!0,icon:t.fromUser.avatar}}),this.desktopNotice.get().click(function(e){$(".visitorDiv ul li[uid="+t.fromUser.userId+"]").click(),room.nwWin.setAlwaysOnTop(!0),room.nwWin.show(),room.nwWin.setAlwaysOnTop(!1)}))}catch(t){console.log(t.message)}},setTaskBarNotice:function(t){room.nwWin&&!room.nwIsMinimize?(room.nwWin.focus(),room.nwWin.blur(),room.nwIsMinimize=!1):room.rmWin&&room.rmWin.open&&!room.rmWin.closed&&room.rmWin.focus()},tipSound:function(){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");var t=$("#tipsound")[0];room.tipSoundObj.storageObj=store.get(room.tipSoundObj.key),common.isBlank(room.tipSoundObj.storageObj)||"on"==room.tipSoundObj.storageObj.turn&&t.play()},getArticleList:function(t,e,o,i,s,r,a,n){try{$.getJSON("/admin/getArticleList",{authorId:common.trim(a),code:t,platform:e,hasContent:o,pageNo:i,pageSize:s,orderByStr:r},function(t){n(t)})}catch(t){console.error("getArticleList->"+t),n(null)}},teacherPointEdit:function(t,e,o){$(t).click(function(){var t=$(this).parent().children("h4").hide(),e=t.text();t.after('<input type="text" name="title" class="edit-title" value="'+e+'" />'),$(this).parent().children("div").removeClass("dn");var o=$(this).parent().children("p").hide(),i=o.text();o.after('<textarea name="content">'+i+"</textarea>"),$(this).parent().children("input[type=button]").removeClass("dn"),$(this).addClass("dn"),room.setListScroll(".point-list .point-list-content ul",{scrollbarPosition:"outside"})}),$(e).click(function(){var t=$(this).parent().children('input[name="_id"]').val(),e=$(this).parent().children('input[name="title"]').val(),o=$(this).parent().find("input[name=publishStartDateStr]").val(),i=$(this).parent().find("input[name=publishEndDateStr]").val(),s=$(this).parent().children("textarea[name=content]").val(),r=$(this).next("input.cancel-btn");if(common.isBlank(e))return void room.showMsg({closeable:!1,msg:"标题不能为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});if(common.isBlank(o))return void room.showMsg({closeable:!1,msg:"发布开始时间不能为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});if(common.isBlank(i))return void room.showMsg({closeable:!1,msg:"发布结束时间为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});if(common.isBlank(s))return void room.showMsg({closeable:!1,msg:"内容不能为空",btns:[{txt:"确定",fn:function(){room.hideMsg()}}]});var a={publishStartDate:o,publishEndDate:i,title:e,content:s},n={_id:t,lang:"zh"};common.getJson("/admin/modifyArticle",{data:JSON.stringify(a),where:JSON.stringify(n)},function(t){t.isOK?(room.showTipBox("观点更新成功！"),r.click()):room.showTipBox("观点更新失败："+t.msg)})}),$(o).click(function(){var t=$(this).parent().children('input[name="title"]').val();$(this).parent().children("h4").show().html(t),$(this).parent().children("input[type!=button]").hide();var e=$(this).parent().children("textarea").hide().val();$(this).parent().children("div").addClass("dn"),$(this).parent().children("p").html(e).show(),$(this).parent().children("input[type=button]").addClass("dn"),$(this).parent().children("input.edit-btn").removeClass("dn"),room.setListScroll(".point-list .point-list-content ul",{scrollbarPosition:"outside"})})},searchUser:function(t){if(common.isValid(t)){$("#userListId li").hide();var e=$('#userListId li .uname label:contains("'+t+'")');$.each(e,function(t,e){$(e).parent().parent().show()})}else $("#userListId li").show()},getWhHistory:function(){return store.enabled?store.get(room.whHistoryUserObj.key+"_"+room.userInfo.groupId):void console.log("Local storage is not supported by your browser.")},setWhHistory:function(t){if(!store.enabled)return void console.log("Local storage is not supported by your browser.");if(room.whHistoryUserObj.whUserList=room.getWhHistory(),$.isArray(room.whHistoryUserObj.whUserList)||(room.whHistoryUserObj.whUserList=[]),t){var e={};room.userInfo.userId==t.fromUser.userId?(e.userId=t.fromUser.toUser.userId,e.utype=t.fromUser.toUser.userType,e.nk=t.fromUser.toUser.nickname,e.dt=common.formatterDateTime(parseInt(t.uiId.replace(/_\d*$/,""),10),"-")):(e.userId=t.fromUser.userId,e.utype=t.fromUser.userType,e.nk=t.fromUser.nickname,e.dt=common.formatterDateTime(parseInt(t.fromUser.publishTime.replace(/_\d*$/,""),10),"-")),e.cg=t.fromUser.clientGroup,e.value=t.content.value,t.content.msgType==room.msgType.img&&(e.value="[图片]");var o=room.whHistoryUserObj.whUserList.length;if(o>0){for(var i=0;i<o;i++){var s=room.whHistoryUserObj.whUserList[i];if(s.userId==e.userId&&(room.whHistoryUserObj.whUserList[i]={}),common.isBlank(s.userId))break}room.whHistoryUserObj.whUserList.unshift(e),o>50&&room.whHistoryUserObj.whUserList.splice(50,o-50),store.set(room.whHistoryUserObj.key+"_"+room.userInfo.groupId,room.whHistoryUserObj.whUserList)}}},fillWhHistory:function(){room.whHistoryUserObj.whUserList=room.getWhHistory();var t="",e=room.formatHtml("whHistory");if($.isArray(room.whHistoryUserObj.whUserList))$.each(room.whHistoryUserObj.whUserList,function(o,i){if(common.isValid(i.userId)){var s=i.dt.substring(5,16);t+=e.formatStr(i.userId,$("#userListId li[id='"+i.userId+"']").length>0?"":' class="off"',i.utype,i.nk,s,i.value)}}),room.setWhHistoryHtml(t);else{var o={groupType:room.userInfo.groupType,groupId:room.userInfo.groupId,userId:room.userInfo.userId};common.getJson("/admin/getLastTwoDaysMsg",{data:JSON.stringify(o)},function(o){o&&($.each(o,function(o,i){var s=common.formatterDateTime(parseInt(i.value.publishTime.replace(/_\d*$/,""),10),"-").substring(5,16),r="",a="",n=0;i.value.userId==room.userInfo.userId?(r=i.value.toUser.nickname,a=i.value.toUser.userId,n=i.value.toUser.userType):(r=i.value.nickname,a=i.value.userId,n=i.value.userType),t+=e.formatStr(a,$("#userListId li[id='"+a+"']").length>0?"":' class="off"',n,r,s,i.value.content.msgType==room.msgType.img?"[图片]":i.value.content.value)}),room.setWhHistoryHtml(t))})}},setWhHistoryHtml:function(t){$(".wh-history .wh_tab_history_div .wh_tab_history_ul").html(t),$(".wh-history .wh_tab_history_div .wh_tab_history_ul li").click(function(){return room.setWhVisitors($(this).attr("utype"),$(this).attr("cg"),$(this).attr("uid"),$(this).find("label:first").text(),!$(this).hasClass("off")),$(".visitorDiv .wh_tab_ul li[uid="+$(this).attr("uid")+"]").click(),$(".wh_tab_history_div").addClass("dn"),!1}),room.setListScroll($(".wh-history .wh_tab_history_div .wh_tab_history_list"))},widthCheck:function(t){var e=$(window).width();e>1680&&($("body").attr("class",""),$("body").addClass("wid1")),e<=1680&&e>1480&&($("body").attr("class",""),$("body").addClass("wid2")),e<=1480&&e>=1280&&($("body").attr("class",""),$("body").addClass("wid3")),e<1280&&($("body").attr("class",""),$("body").addClass("wid4")),$(".open_wh_box").is(":hidden")||t?$('.visitorDiv ul li[uid="public"]').hasClass("on")?$(".local_box .wh-middle").width(e-425):$(".local_box .wh-middle").width(e-210):$(".open_wh_box .wh-middle").width($(".open_wh_box").width()-210)},heightCalcu:function(t){var e=".local_box",o=$(window).height(),i=130,s=95;$(".open_wh_box").is(":hidden")||t?($(".onlineSearch").hasClass("dn")?$(".user_box").height(o-180).css("max-height",o-180+"px"):$(".user_box").height(o-205).css("max-height",o-205+"px"),$(".right-teacher").height(o-10),$(".wh_tab_history_div").css({top:"75px"})):(s=20,$(".wh_tab_history_div").css({top:"27px"}),o=$(".open_wh_box").height()-25,e=".open_wh_box",i=60),$(e+" .wh-left,"+e+" .wh-middle").height(o-10),$(e+" .visitorDiv .wh_tab_div").height($(e+" .wh-left").height()-i),$(e+" .visitorDiv .wh_tab_history_list").height($(e+" .wh-left").height()-s),$(e+" .wh-tab-msg").height(o-80),$(e+" .wh-content").height(o-230)},formatHtml:function(t){var e=[];switch(t){case"point-list":e.push("<li{0}>"),e.push('    <input type="hidden" name="_id" value="{1}" />'),e.push("    <h4>{2}</h4>"),e.push('    <div class="dn">'),e.push('        从<input type="text" name="publishStartDateStr" id="publishStartDateStr_{1}" class="date" onfocus="WdatePicker({maxDate:\'#F{$dp.$D(\\\'publishEndDateStr_{1}\\\')}\',dateFmt:\'yyyy-MM-dd HH:mm:ss\'})" value="{3}" />'),e.push('        到<input type="text" name="publishEndDateStr" id="publishEndDateStr_{1}" class="date" onfocus="WdatePicker({minDate:\'#F{$dp.$D(\\\'publishStartDateStr_{1}\\\')}\',dateFmt:\'yyyy-MM-dd HH:mm:ss\'})" value="{4}" />'),e.push("    </div>"),e.push("     <p>{5}</p>"),e.push('     <input type="button" value="编辑" class="edit-btn" />'),e.push('     <input type="button" value="提交" class="save-btn dn" />'),e.push('     <input type="button" value="取消" class="cancel-btn dn" />'),e.push("</li>");break;case"whHistory":e.push('<li uid="{0}"{1} utype="{2}"><span class="user-row"><label>{3}</label><label>{4}</label></span><span class="user-msg">{5}</span></li>')}return e.join("")}},_gaq=_gaq||[],_hmt=_hmt||[];UUID.prototype.valueOf=function(){return this.id},UUID.prototype.toString=function(){return this.id},UUID.prototype.createUUID=function(t){var e=new Date(1582,10,15,0,0,0,0),o=new Date,i=o.getTime()-e.getTime(),s=UUID.getIntegerBits(i,0,31),r=UUID.getIntegerBits(i,32,47),a=UUID.getIntegerBits(i,48,59)+"1",n=UUID.getIntegerBits(UUID.rand(4095),0,7),l=UUID.getIntegerBits(UUID.rand(4095),0,7),u=UUID.getIntegerBits(UUID.rand(8191),0,7)+UUID.getIntegerBits(UUID.rand(8191),8,15)+UUID.getIntegerBits(UUID.rand(8191),0,7)+UUID.getIntegerBits(UUID.rand(8191),8,15)+UUID.getIntegerBits(UUID.rand(8191),0,15);return(t||"")+s+r+a+n+l+u},UUID.getIntegerBits=function(t,e,o){var i=UUID.returnBase(t,16),s=new Array,r="",a=0;for(a=0;a<i.length;a++)s.push(i.substring(a,a+1));for(a=Math.floor(e/4);a<=Math.floor(o/4);a++)r+=s[a]&&""!=s[a]?s[a]:"0";return r},UUID.returnBase=function(t,e){return t.toString(e).toUpperCase()},UUID.rand=function(t){return Math.floor(Math.random()*(t+1))};var chatAnalyze={localHref:window.location.href,utmStore:{userIp:"",storeKey:"GWAFLGPHONECOOIKETRACK",userId:"",roomId:"",userTel:"",userType:"",userName:"",roomName:"",userSource:"web",useEquipment:"",tradingAccount:"",tradingPlatform:"",platformType:0,businessPlatform:"",operateEntrance:"",operationType:2,touristId:"",sessionId:"",nickName:"",email:"",videoId:"",videoName:"",courseId:"",courseName:"",teacherId:"",teacherName:""},isLocalHref:function(){return/^https?:\/\/(\d{1,3}\.){3}\d{1,3}.+/.test(chatAnalyze.localHref)},init:function(){if(!this.isLocalHref()){var t="";chatAnalyze.localHref.indexOf("/studio")!=-1?t="studio":chatAnalyze.localHref.indexOf("/fxstudio")!=-1?t="fxstudio":chatAnalyze.localHref.indexOf("/hxstudio")!=-1&&(t="hxstudio"),""!=t&&(this.initGA(t),this.setGA(),this.setBaidu())}},initGA:function(t){"studio"==t&&(_gaq.push(["_setAccount","UA-31478987-1"]),_gaq.push(["_setDomainName","24k.hk"]),_gaq.push(["_addIgnoredRef","24k.hk"])),"fxstudio"==t&&(_gaq.push(["_setAccount","UA-49389835-1"]),_gaq.push(["_setDomainName","gwfx.com"]),_gaq.push(["_addIgnoredRef","gwfx.com"])),"hxstudio"==t&&(_gaq.push(["_setAccount",""]),_gaq.push(["_setDomainName","handan.hx9999"]),_gaq.push(["_addIgnoredRef","handan.hx9999"])),_gaq.push(["_setAllowLinker",!0]),_gaq.push(["_addOrganic","soso","w"]),_gaq.push(["_addOrganic","sogou","query"]),_gaq.push(["_addOrganic","youdao","q"]),_gaq.push(["_addOrganic","baidu","word"]),_gaq.push(["_addOrganic","baidu","q1"]),_gaq.push(["_addOrganic","ucweb","keyword"]),_gaq.push(["_addOrganic","ucweb","word"]),_gaq.push(["_addOrganic","114so","kw"]),_gaq.push(["_addOrganic","360","q"]),_gaq.push(["_addOrganic","so","q"]),_gaq.push(["_trackPageview"])},setGA:function(){try{var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}catch(t){console.log("Set GA fail!"+t)}},setBaidu:function(){try{var t=document.createElement("script");t.src="//hm.baidu.com/hm.js?52a2828b884f1a2ba8a3e25efe98eb65";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}catch(t){console.log("Set GA fail!"+t)}},getIp:function(t){chatAnalyze.utmStore.userIp?t&&t():$.getJSON("https://oa.24k.hk/ajax/getIp?callback=ip&_="+Math.random(),function(e){chatAnalyze.utmStore.userIp=e.Ip,t&&t()})},getUTMCookie:function(){for(var t=document.cookie,e=t.split(/[;&]/),o=0;o<e.length;o++){var i=e[o].split("=");if($.trim(i[0])==this.utmStore.storeKey)return i[1]}var s=document.domain;$.inArray(s,["pmchat.24k.hk","chat.gwfx.com","handan.hx9999.com"])>-1&&(chatAnalyze.localHref.indexOf("/studio")!=-1?s=".24k.hk":chatAnalyze.localHref.indexOf("/fxstudio")!=-1?s=".gwfx.com":chatAnalyze.localHref.indexOf("/hxstudio")!=-1&&(s=".hx9999.com"));var r="";switch(s){case".24k.hk":r="G";break;case".gwfx.com":r="C";break;case".hx9999.com":r="H"}var a=UUID.prototype.createUUID(r);return document.cookie=this.utmStore.storeKey+"="+escape(a)+"; expires=Tue, 31 Dec 2030 00:00:00 UTC; path=/;domain="+s,a},setUTM:function(t,e){try{if(t)this.utmStore.roomId=e.groupId,this.utmStore.userId=e.userId,this.utmStore.userTel=e.userTel,this.utmStore.clientGroup=e.clientGroup,this.utmStore.groupType=e.groupType,$(window).unload(function(){chatAnalyze.utmStore.onlineETM=(new Date).getTime(),window.event.returnValue=!0});else if(chatAnalyze.utmStore.userId=chatAnalyze.getUTMCookie(),chatAnalyze.utmStore.userType=chatAnalyze.getClientGroup(e.clientGroup),chatAnalyze.utmStore.businessPlatform=chatAnalyze.getGroupType(e.groupType),chatAnalyze.utmStore.roomId=e.groupId,chatAnalyze.utmStore.userTel=e.mobile,chatAnalyze.utmStore.userName=e.userName,chatAnalyze.utmStore.roomName=e.roomName,chatAnalyze.utmStore.platformType=common.isMobile(navigator.userAgent)?1:0,chatAnalyze.utmStore.touristId=e.visitorId,chatAnalyze.utmStore.sessionId=e.sid,chatAnalyze.utmStore.nickName=e.nickname,chatAnalyze.utmStore.email=e.email,chatAnalyze.utmStore.useEquipment=navigator.userAgent,chatAnalyze.utmStore.operateEntrance=common.isBlank(common.getUrlParam("platform"))?"web":common.getUrlParam("platform"),chatAnalyze.utmStore.courseId=e.courseId||"",chatAnalyze.utmStore.courseName=e.courseName,chatAnalyze.utmStore.teacherId=e.lecturerId||"",chatAnalyze.utmStore.teacherName=e.lecturer||"",o&&(chatAnalyze.utmStore.userIp=e.ip),chatAnalyze.utmStore.operationType=e.operationType,chatAnalyze.utmStore.tradingAccount=e.accountNo||"",e&&7==e.operationType&&(chatAnalyze.utmStore.videoId=e.videoId,chatAnalyze.utmStore.videoName=e.videoName),e=chatAnalyze.utmStore,common.isValid(e.sessionId)&&common.isValid(e.userId)&&(common.isValid(e.touristId)||common.isValid(e.userTel))&&common.isValid(e.operationType)){var o=this.isLocalHref(),i=o?"http://testweboa.gwfx.com:8088/GwUserTrackingManager_NEW/put/insertRoom":"https://das.gwfx.com/put/insertRoom";o?chatAnalyze.getIp(function(){chatAnalyze.utmAjax(i,e,!0)}):(e=chatAnalyze.utmStore,chatAnalyze.getIp(function(){chatAnalyze.utmAjax(i,e,!0)}))}}catch(t){console.log("Set UTM fail!"+t)}},utmAjax:function(t,e,o){$.post(t,{data:JSON.stringify(e),callback:"?"},function(t){})},sendUTM:function(t){return!1},getClientGroup:function(t){var e=1;switch(t){case"visitor":e=1;break;case"register":e=2;break;case"simulate":e=3;break;case"active":e=4;break;case"notActive":e=5;break;case"vip":e=6;break;case"analyst":e=7;break;case"admin":e=8;break;case"cs":e=9;break;default:e=1}return e},getGroupType:function(t){var e=1;return e=/^fx/.test(t)?1:/^hx/.test(t)?3:2}};$(function(){chatAnalyze.init()});